<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p - AI Chatbox</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-card { background: #2d2d2d; padding: 40px; border-radius: 12px; width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; transition: height 0.3s; }
        h2 { margin-bottom: 25px; color: #e0e0e0; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        input { width: 100%; padding: 12px; background: #404040; border: 1px solid #505050; color: white; border-radius: 6px; box-sizing: border-box; outline: none; transition: 0.2s; }
        input:focus { border-color: #007acc; }
        
        /* ·∫®n hi·ªán input v·ªõi hi·ªáu ·ª©ng */
        .hidden-input { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .visible-input { display: block; opacity: 1; }

        button { width: 100%; padding: 12px; margin-top: 10px; background: #007acc; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        button:hover { background: #0062a3; }
        
        .switch-btn { background: transparent; color: #888; font-size: 0.9rem; margin-top: 15px; }
        .switch-btn:hover { color: white; text-decoration: underline; background: transparent; }
        
        .error { color: #ff4d4f; font-size: 0.85rem; margin-top: 10px; display: none; background: rgba(255, 77, 79, 0.1); padding: 8px; border-radius: 4px; }
        
        .hint { font-size: 0.75rem; color: #888; margin-top: 4px; display: none; }
    </style>
</head>
<body>
    <div class="login-card">
        <h2 id="title">üîê ƒêƒÉng Nh·∫≠p</h2>
        
        <div class="input-group">
            <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        </div>
        
        <div class="input-group">
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
            <div id="passHint" class="hint">M·∫≠t kh·∫©u c·∫ßn > 6 k√Ω t·ª±, g·ªìm ch·ªØ v√† s·ªë</div>
        </div>
        
        <div class="input-group hidden-input" id="confirmContainer">
            <input type="password" id="confirmPassword" placeholder="X√°c nh·∫≠n l·∫°i m·∫≠t kh·∫©u">
        </div>
        
        <div id="errorMsg" class="error"></div>
        
        <button onclick="handleSubmit()" id="submitBtn">ƒêƒÉng Nh·∫≠p</button>
        <button class="switch-btn" onclick="toggleMode()" id="switchBtn">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</button>
    </div>

    <script>
        let isLogin = true;
        const errorDiv = document.getElementById('errorMsg');
        const confirmContainer = document.getElementById('confirmContainer');
        const passHint = document.getElementById('passHint');

        function toggleMode() {
            isLogin = !isLogin;
            
            // C·∫≠p nh·∫≠t giao di·ªán
            document.getElementById('title').innerText = isLogin ? "üîê ƒêƒÉng Nh·∫≠p" : "üìù ƒêƒÉng K√Ω";
            document.getElementById('submitBtn').innerText = isLogin ? "ƒêƒÉng Nh·∫≠p" : "ƒêƒÉng K√Ω";
            document.getElementById('switchBtn').innerText = isLogin ? "Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay" : "ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p";
            
            // ·∫®n/Hi·ªán √¥ x√°c nh·∫≠n m·∫≠t kh·∫©u v√† g·ª£i √Ω
            if (isLogin) {
                confirmContainer.classList.remove('visible-input');
                confirmContainer.classList.add('hidden-input');
                passHint.style.display = 'none';
            } else {
                confirmContainer.classList.remove('hidden-input');
                confirmContainer.classList.add('visible-input');
                passHint.style.display = 'block';
            }
            
            // X√≥a l·ªói c≈©
            errorDiv.style.display = 'none';
        }

        async function handleSubmit() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // --- VALIDATION PH√çA CLIENT (Cho nhanh) ---
            if(!username || !password) {
                return showError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            }

            if (!isLogin) {
                // C√°c ki·ªÉm tra ch·ªâ d√†nh cho ƒêƒÉng k√Ω
                if (username.length < 3) {
                    return showError("T√™n ƒëƒÉng nh·∫≠p qu√° ng·∫Øn (ph·∫£i >= 3 k√Ω t·ª±).");
                }
                
                // Regex: C√≥ ch·ªØ v√† s·ªë, d√†i h∆°n 6
                const strongRegex = new RegExp("^(?=.*[a-zA-Z])(?=.*[0-9])(?=.{6,})");
                if (!strongRegex.test(password)) {
                    return showError("C·∫ßn √≠t nh·∫•t 6 k√Ω t·ª±, g·ªìm c·∫£ ch·ªØ v√† s·ªë.");
                }

                if (password !== confirmPassword) {
                    return showError("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!");
                }
            }

            // G·ª≠i d·ªØ li·ªáu
            const endpoint = isLogin ? '/login' : '/register';
            const payload = { username, password };
            
            // N·∫øu l√† ƒëƒÉng k√Ω th√¨ g·ª≠i th√™m confirm_password
            if (!isLogin) payload.confirm_password = confirmPassword;

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    if(isLogin) {
                        window.location.href = '/'; 
                    } else {
                        alert("‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
                        toggleMode(); // Chuy·ªÉn v·ªÅ form ƒëƒÉng nh·∫≠p
                    }
                } else {
                    showError(data.msg);
                }
            } catch (e) { showError("L·ªói k·∫øt n·ªëi server!"); }
        }

        function showError(msg) {
            errorDiv.innerText = msg;
            errorDiv.style.display = 'block';
        }
        
        // H·ªó tr·ª£ b·∫•m Enter
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') handleSubmit();
        });
    </script>
</body>
</html>