<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbox Pro</title>
    <style>
        /* --- 1. VARIABLES --- */
        :root {
            --bg-body: #1a1a1a;
            --bg-sidebar: #202020;
            --bg-chat: #2d2d2d;
            --hover-item: #333333;
            --text-main: #e0e0e0;
            --text-sub: #9ca3af;
            --border: #404040;
            --msg-user: #007acc;
            --msg-bot: #404040;
        }
        [data-theme="light"] {
            --bg-body: #f3f4f6;
            --bg-sidebar: #ffffff;
            --bg-chat: #ffffff;
            --hover-item: #f3f4f6;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --msg-user: #2563eb;
            --msg-bot: #f3f4f6;
        }

        /* --- 2. LAYOUT --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background: var(--bg-body); color: var(--text-main); overflow: hidden; }
        
        /* SIDEBAR (B√™n tr√°i) */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: 0.3s;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .new-chat-btn {
            width: 100%; padding: 12px; background: var(--msg-user); color: white;
            border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .new-chat-btn:hover { opacity: 0.9; }
        
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item {
            padding: 10px 12px; margin-bottom: 4px; border-radius: 6px;
            cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: var(--text-sub); font-size: 0.9rem;
        }
        .history-item:hover { background: var(--hover-item); color: var(--text-main); }
        
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        /* MAIN CHAT (B√™n ph·∫£i) */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        
        .chat-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-chat);
        }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 80%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; font-size: 0.95rem; }
        .user { align-self: flex-end; background: var(--msg-user); color: white; border-bottom-right-radius: 2px; }
        .bot { align-self: flex-start; background: var(--msg-bot); color: var(--text-main); border-bottom-left-radius: 2px; }

        .input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--bg-chat); }
        .input-area input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-sidebar); color: var(--text-main); outline: none; }
        
        /* Utility Buttons */
        .icon-btn { background: none; border: 1px solid var(--border); color: var(--text-main); padding: 8px; border-radius: 6px; cursor: pointer; }
        .icon-btn:hover { background: var(--hover-item); }
        .del-btn { color: #ef4444; border-color: #ef4444; }
        .del-btn:hover { background: #fee2e2; }

        /* Thanh tr∆∞·ª£t c√†i ƒë·∫∑t AI */
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-row input[type="range"] {
            flex: 1;
        }
        .slider-value {
            width: 50px;
            text-align: right;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        /* Settings modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal {
            background: var(--bg-sidebar);
            padding: 20px 24px;
            border-radius: 10px;
            width: 380px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .modal h3 { margin-top: 0; margin-bottom: 16px; }
        .modal-row { margin-bottom: 14px; }
        .modal-row label { display:block; font-size:0.9rem; margin-bottom:4px; color:var(--text-sub); }
        .modal-row .value { float:right; font-size:0.9rem; }
        .modal-footer { margin-top: 18px; display:flex; justify-content:flex-end; gap:10px; }
        .btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-chat);
            color: var(--text-main);
            cursor: pointer;
        }
        .btn-primary {
            background: var(--msg-user);
            border-color: var(--msg-user);
            color: #fff;
        }

    </style>
</head>
<body>

<div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">+ Cu·ªôc tr√≤ chuy·ªán m·ªõi</button>
        </div>

    <!-- Modal c√†i ƒë·∫∑t tham s·ªë AI -->
    <div class="modal-backdrop" id="settingsBackdrop">
        <div class="modal">
            <h3>C√†i ƒë·∫∑t tham s·ªë AI</h3>

            <div class="modal-row">
                <label for="tempRange">ƒê·ªô s√°ng t·∫°o (Temperature)</label>
                <div class="slider-row">
                    <input type="range" id="tempRange" min="0.1" max="2.0" step="0.1" value="0.8" oninput="syncTemp()">
                    <span class="slider-value" id="tempValue">0.8</span>
                </div>
            </div>

            <div class="modal-row">
                <label for="maxTokensRange">ƒê·ªô d√†i t·ªëi ƒëa (Max Tokens)</label>
                <div class="slider-row">
                    <input type="range" id="maxTokensRange" min="64" max="2048" step="64" value="512" oninput="syncMaxTokens()">
                    <span class="slider-value" id="maxTokensValue">512</span>
                </div>
            </div>

            <div class="modal-row">
                <label for="toppRange">Top P</label>
                <div class="slider-row">
                    <input type="range" id="toppRange" min="0.1" max="1.0" step="0.05" value="0.95" oninput="syncTopP()">
                    <span class="slider-value" id="toppValue">0.95</span>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn" onclick="closeSettingsModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveSettings()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>
        
        <div class="history-list" id="historyList">
            <div style="padding:10px; color:gray; font-style:italic">ƒêang t·∫£i l·ªãch s·ª≠...</div>
        </div>
        
        <div class="sidebar-footer" style="flex-direction: column; gap: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; color:var(--text-main); font-size:0.9rem; padding: 0 5px;">
                <span>üë§ {{ username }}</span>
                <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="ƒê·ªïi giao di·ªán">‚òÄÔ∏è</button>
            </div>
            <div style="display:flex; gap:5px">
                <button class="icon-btn del-btn" onclick="clearAll()" style="flex:1" title="X√≥a l·ªãch s·ª≠">üóëÔ∏è X√≥a</button>
                <a href="/logout" class="icon-btn" style="text-decoration:none; text-align:center; background:#404040" title="ƒêƒÉng xu·∫•t">üö™</a>
            </div>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-header">
            <h3 style="margin:0">ü§ñ Chatbox AI</h3>
            <button class="icon-btn" onclick="openSettingsModal()">C√†i ƒë·∫∑t tham s·ªë AI</button>
        </div>
        
        <div class="chat-box" id="chatBox">
            <div class="message bot">Xin ch√†o! B·∫°n mu·ªën h·ªèi g√¨ h√¥m nay?</div>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleEnter(event)">
            <button class="new-chat-btn" style="width:auto" onclick="sendMessage()">G·ª≠i ‚û§</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const historyList = document.getElementById('historyList');
        const settingsBackdrop = document.getElementById('settingsBackdrop');

        // --- 1. QU·∫¢N L√ù L·ªäCH S·ª¨ ---
        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const list = await res.json();
                
                historyList.innerHTML = '';
                if(list.length === 0) {
                    historyList.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-sub)">Ch∆∞a c√≥ l·ªãch s·ª≠</div>';
                    return;
                }

                list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerText = item.title || "Cu·ªôc tr√≤ chuy·ªán kh√¥ng t√™n";
                    div.onclick = () => loadConversation(item.id);
                    historyList.appendChild(div);
                });
            } catch (e) { console.error("L·ªói t·∫£i history:", e); }
        }

        async function loadConversation(id) {
            chatBox.innerHTML = '<div style="text-align:center; padding:20px">‚è≥ ƒêang t·∫£i...</div>';
            try {
                const res = await fetch(`/api/load_chat/${id}`);
                const messages = await res.json();
                
                chatBox.innerHTML = ''; // X√≥a loading
                if(messages.length === 0) {
                    chatBox.innerHTML = '<div class="message bot">Cu·ªôc tr√≤ chuy·ªán n√†y tr·ªëng.</div>';
                }
                messages.forEach(msg => appendMessage(msg.content, msg.role));
            } catch (e) {
                chatBox.innerHTML = '<div class="message bot">‚ùå L·ªói t·∫£i cu·ªôc tr√≤ chuy·ªán</div>';
            }
        }

        async function startNewChat() {
            await fetch('/new_chat', {method: 'POST'});
            chatBox.innerHTML = '<div class="message bot">B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi! üëã</div>';
            loadHistory(); // Refresh list
        }

        async function clearAll() {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò l·ªãch s·ª≠?")) {
                await fetch('/clear_all', {method: 'POST'});
                startNewChat();
            }
        }

        // --- 2. X·ª¨ L√ù CHAT ---
        function appendMessage(text, role) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            userInput.value = '';
            
            // N·∫øu ƒë√¢y l√† tin nh·∫Øn ƒë·∫ßu ti√™n, h√£y refresh sidebar sau 1 ch√∫t
            const isFirstMessage = chatBox.children.length <= 2;

            try {
                const res = await fetch('/get_response', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({msg: text})
                });
                const data = await res.json();
                appendMessage(data.response, 'bot');
                
                if(isFirstMessage) setTimeout(loadHistory, 1000);
                
            } catch (e) { appendMessage("L·ªói k·∫øt n·ªëi!", 'bot'); }
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        // --- 3. THEME ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeBtn').innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }
        
        // --- 4. C√ÄI ƒê·∫∂T THAM S·ªê AI ---
        function openSettingsModal() {
            settingsBackdrop.style.display = 'flex';
            loadSettings();
        }

        function closeSettingsModal() {
            settingsBackdrop.style.display = 'none';
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                if (data) {
                    const t = Number(data.temperature) || 0.8;
                    const mt = Number(data.max_tokens) || 512;
                    const tp = Number(data.top_p) || 0.95;

                    document.getElementById('tempRange').value = t;
                    document.getElementById('maxTokensRange').value = mt;
                    document.getElementById('toppRange').value = tp;

                    document.getElementById('tempValue').innerText = t.toFixed(1);
                    document.getElementById('maxTokensValue').innerText = mt;
                    document.getElementById('toppValue').innerText = tp.toFixed(2);
                }
            } catch (e) {
                console.error('L·ªói t·∫£i c√†i ƒë·∫∑t:', e);
            }
        }

        function syncTemp() {
            const v = Number(document.getElementById('tempRange').value || 0.8);
            document.getElementById('tempValue').innerText = v.toFixed(1);
        }

        function syncMaxTokens() {
            const v = Number(document.getElementById('maxTokensRange').value || 512);
            document.getElementById('maxTokensValue').innerText = v;
        }

        function syncTopP() {
            const v = Number(document.getElementById('toppRange').value || 0.95);
            document.getElementById('toppValue').innerText = v.toFixed(2);
        }

        async function saveSettings() {
            let temp = Number(document.getElementById('tempRange').value || 0.8);
            let maxTokens = Number(document.getElementById('maxTokensRange').value || 512);
            let topP = Number(document.getElementById('toppRange').value || 0.95);

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        temperature: temp,
                        max_tokens: maxTokens,
                        top_p: topP
                    })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    closeSettingsModal();
                } else {
                    alert(data.msg || 'Kh√¥ng l∆∞u ƒë∆∞·ª£c c√†i ƒë·∫∑t.');
                }
            } catch (e) {
                alert('L·ªói k·∫øt n·ªëi khi l∆∞u c√†i ƒë·∫∑t.');
            }
        }

        // Init
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
        loadHistory(); // T·∫£i l·ªãch s·ª≠ khi m·ªü web
    </script>
</body>
</html>